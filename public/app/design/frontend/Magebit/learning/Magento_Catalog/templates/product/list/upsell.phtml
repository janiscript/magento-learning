<?php
/**
 * Custom upsell products template with reviews and actions enabled
 */
/** @var \Magento\Catalog\Block\Product\ProductList\Upsell $block */
/** @var \Magento\Framework\Escaper $escaper */

$items = $block->getItemCollection()->getItems();

$exist = count($items);
?>

<?php if ($exist): ?>
<div class="block upsell" data-mage-init='{"upsellProducts":{}}' data-limit="<?= $escaper->escapeHtmlAttr($block->getItemLimit('upsell')) ?>">
    <div class="block-title title">
        <strong id="block-upsell-heading" role="heading" aria-level="2">
            <?= $escaper->escapeHtml(__('We found other products you might like!')) ?>
        </strong>
    </div>
    <div class="block-content content" aria-labelledby="block-upsell-heading">
        <div class="products wrapper grid products-grid products-upsell">
            <ol class="products list items product-items">
                <?php foreach ($items as $_item): ?>
                <li class="item product product-item" id="product-item_<?= /* @noEscape */ $_item->getId() ?>">
                    <div class="product-item-info">
                        <a href="<?= $escaper->escapeUrl($block->getProductUrl($_item)) ?>" class="product photo product-item-photo">
                            <?= $block->getImage($_item, 'upsell_products_list')->toHtml() ?>
                        </a>
                        <div class="product details product-item-details">
                            <strong class="product name product-item-name">
                                <a class="product-item-link"
                                   title="<?= $escaper->escapeHtmlAttr($_item->getName()) ?>"
                                   href="<?= $escaper->escapeUrl($block->getProductUrl($_item)) ?>">
                                    <?= $escaper->escapeHtml($_item->getName()) ?>
                                </a>
                            </strong>

                            <?= $block->getReviewsSummaryHtml($_item, \Magento\Catalog\Block\Product\ReviewRendererInterface::SHORT_VIEW) ?>

                            <?= /* @noEscape */ $block->getProductPrice($_item) ?>
                        </div>
                        
                        <div class="product actions product-item-actions">
                            <div class="actions-primary">
                                <?php if ($_item->isSaleable()): ?>
                                <!-- Default "View Product" button -->
                                <a href="<?= $escaper->escapeUrl($block->getProductUrl($_item)) ?>" 
                                   class="action primary view-product"
                                   title="<?= $escaper->escapeHtmlAttr(__('View Product')) ?>">
                                    <span><?= $escaper->escapeHtml(__('View Product')) ?></span>
                                </a>
                                
                                <!-- "Add to Cart" button (hidden by CSS) -->
                                <?php if (!$_item->isComposite() && !$_item->getRequiredOptions()): ?>
                                <form data-role="tocart-form" 
                                      data-product-sku="<?= $escaper->escapeHtmlAttr($_item->getSku()) ?>" 
                                      action="<?= $escaper->escapeUrl($block->getAddToCartUrl($_item)) ?>" 
                                      method="post">
                                    <input type="hidden" name="product" value="<?= $escaper->escapeHtmlAttr($_item->getId()) ?>" />
                                    <?= $block->getBlockHtml('formkey') ?>
                                    <button type="submit" 
                                            title="<?= $escaper->escapeHtmlAttr(__('Add to Cart')) ?>" 
                                            class="action primary tocart">
                                        <span><?= $escaper->escapeHtml(__('Add to Cart')) ?></span>
                                    </button>
                                </form>
                                <?php endif; ?>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                </li>
                <?php endforeach; ?>
            </ol>
        </div>
    </div>
</div>
<?php endif; ?> 